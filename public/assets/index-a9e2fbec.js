import{r as l,aK as y,a as m,aL as T,S as L,j as n,aM as B,B as D,X as j}from"./index-c8148c41.js";import"./index-c467507d.js";import{T as r}from"./index-1c8757fc.js";import{n as p}from"./index.browser-7e542916.js";import{l as K}from"./index-93ef027d.js";import{b as M}from"./service-4669bc73.js";function O({data:d,onClose:f}){const C=[{title:"客户",dataIndex:"order.customer.name"},{title:"品名",dataIndex:"categoryName"},{title:"件重",dataIndex:"singleWeight"},{title:"圈号",dataIndex:"circle"},{title:"合计",dataIndex:"typeCount"}],[u,h]=l.useState([]),[g,x]=l.useState([]),[c,S]=l.useState(100);l.useEffect(()=>{const a=y.groupBy(d,e=>`${e.category}-${e.singleWeight}-${e.circle}-${e.order.customer.name}`),t=Object.keys(a).map(e=>{const s=a[e];let o=0;return s.forEach(i=>o+=i.quantity),{key:p(),...s[0],typeCount:o}});h(t)},[]);async function b(){R()}function k(a){return m(r.Summary.Row,{children:[n(r.Summary.Cell,{children:"总计"}),n(r.Summary.Cell,{}),n(r.Summary.Cell,{}),n(r.Summary.Cell,{}),n(r.Summary.Cell,{children:a.reduce((t,e)=>t+e.typeCount,0)})]})}const w=l.useRef(null);K.useReactToPrint({content:()=>w.current});const E=()=>{const a=y.cloneDeep(u);a.forEach(t=>{const e=Math.floor(t.typeCount/c),s=Math.floor(t.typeCount%c),o=[];if(t.children=[],e===0)o.push({...t,key:p()});else{for(let i=0;i<e;i++)o.push({...t,typeCount:c,key:p()});s!==0&&o.push({...t,typeCount:s,key:p()})}t.children=o}),x(a.map(t=>t.key)),h(a)},R=()=>{const a=[];u.forEach(t=>t.children.forEach(e=>{delete e.id,delete e.key,delete e.order,delete e.unitPrice,delete e.totalPrice,delete e.totalWeight,delete e.typeCount,delete e.children,a.push(e)})),M({orderDetails:d,transfers:a}).then(()=>{j.success("生成流程单成功！"),f()})};return m(T,{height:"100%",placement:"bottom",title:"生产单",visible:!0,onOk:b,autoFocus:!1,focusLock:!1,onCancel:f,children:[m(L,{children:[n(B,{min:0,value:c,onChange:a=>{S(a)},style:{width:160}}),n(D,{type:"primary",style:{marginBottom:10},onClick:E,children:"分单"})]}),u.length>0&&n(r,{summary:k,rowKey:"key",pagination:!1,expandedRowKeys:g,columns:C,data:y.sortBy(u,["category","customerId"]),defaultExpandAllRows:!0,indentSize:60,border:!0,borderCell:!0})]})}export{O as default};
